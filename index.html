<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linda – Deine persönliche Assistentin (Comic)</title>

  <!-- Manifest & Mobile Meta -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2346e4" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="ChatBot" />

  <!-- Icons & Schriftarten -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Segoe+Script&family=Comic+Sans+MS&display=swap"
    rel="stylesheet"
  />

  <style>
    /* Reset & Global */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: 'Inter', sans-serif; }
    body { display: flex; background: #f7f7f8; color: #24292e; overflow: hidden; }

    /* Modal-Overlay & Card (gültig für beide) */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,38,90,0.45);
      z-index: 3000; display: flex; align-items: center; justify-content: center;
    }
    .modal-card {
      background: #fff; border-radius: 16px; max-width: 500px; width: 90vw;
      box-shadow: 0 8px 32px rgba(0,70,160,0.13); overflow: hidden;
      border: 1.5px solid #0059b3;
    }
    .modal-head {
      background: #0059b3; color: #fff; padding: 20px 26px;
      display: flex; align-items: center; font-size: 1.12rem; font-weight: 600;
    }
    .modal-head .fa-lock,
    .modal-head .fa-bullhorn { margin-right: 12px; font-size: 1.2rem; }
    .modal-content {
      padding: 22px; font-size: 1.03rem; color: #1c273a;
      line-height: 1.5;
    }
    .modal-content ul { margin: 14px 0 0 18px; }
    .modal-footer {
      display: flex; justify-content: flex-end; gap: 14px;
      padding: 0 22px 18px;
    }
    .modal-btn {
      padding: 11px 28px; border-radius: 20px; border: none;
      font-size: 1.06rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 1px 5px rgba(0,89,179,0.06);
      transition: background .14s, color .12s;
    }
    .modal-btn.accept { background: #0059b3; color: #fff; }
    .modal-btn.accept:hover { background: #003974; }
    .modal-btn.decline {
      background: #f3f4f6; color: #0059b3; border: 1px solid #c7d5ea;
    }
    .modal-btn.decline:hover { background: #eaf1fa; color: #003974; }

    /* Haupt-Interface (versteckt bis beide Zustimmungen) */
    #mainContainer { display: none; width: 100%; height: 100%; }
    .container { display: flex; width: 100%; height: 100%; }
    .comic {
      flex: 0 0 300px; background: #fff;
      display: flex; flex-direction: column; align-items: center;
      border-right: 1px solid #e1e4e8; padding: 1rem;
    }
    .comic img { width: 100%; border-radius: .5rem; }
    .comic-name {
      margin-top: .5rem;
      font-family: 'Segoe Script','Comic Sans MS',cursive;
      font-size: 1.5rem; color: #333;
    }
    .chat-area {
      position: relative; flex: 1; display: flex; flex-direction: column;
    }
    .chat-area header {
      padding: 1rem 1.5rem; font-size: 1.25rem; font-weight: 500;
      background: #fff; border-bottom: 1px solid #e1e4e8;
    }

    /* Steuerungs-Icons oben rechts */
    .chat-controls {
      position: absolute; top: 1rem; right: 1.5rem;
      display: flex; gap: .5rem; z-index: 5;
    }
    .control-btn {
      background: rgba(255,255,255,0.8); border: 1px solid #e1e4e8;
      border-radius: .5rem; width: 2.3rem; height: 2.3rem;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem; color: #57606a; cursor: pointer;
      transition: background .2s, color .2s;
    }
    .control-btn:hover { background: #fff; color: #24292e; }

    /* Chatfenster */
    #chat {
      flex: 1; overflow-y: auto; padding: 1rem 1.5rem;
      display: flex; flex-direction: column; gap: 1rem;
      background: #f7f7f8;
    }
    .message {
      max-width: 75%; padding: .75rem 1rem; border-radius: 1rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1.5;
    }
    .bot { align-self: flex-start; background: #fff; color: #24292e; }
    .user { align-self: flex-end; background: #0969da; color: #fff; }

    /* Input-Bar */
    .input-bar {
      display: flex; align-items: center;
      padding: .5rem 1rem calc(env(safe-area-inset-bottom)+.5rem);
      background: #fff; border-top: 1px solid #e1e4e8;
    }
    .input-bar button {
      background: none; border: none; font-size: 1.5rem;
      cursor: pointer; color: #57606a; margin: 0 .25rem;
      padding: .75rem;
    }
    .input-bar button:hover { color: #24292e; }
    #q {
      flex: 1; border: none; outline: none;
      background: #f0f4f8; border-radius: .5rem;
      padding: 1rem; margin: 0 .5rem; font-size: 1rem;
      line-height: 1.4;
    }
    .recording { color: #d00!important; }

    @media (max-width: 600px) {
      .container { flex-direction: column; }
      .comic { border-right: none; border-bottom: 1px solid #e1e4e8; }
      .chat-controls { top: .75rem; right: 1rem; }
    }
  </style>
</head>

<body>
  <!-- 1) Datenschutzhinweis -->
  <div class="modal-overlay" id="privacy-modal">
    <div class="modal-card">
      <div class="modal-head"><i class="fa-solid fa-lock"></i>Datenschutzhinweis</div>
      <div class="modal-content">
        <p>Um diesen Chatbot nutzen zu können, ist deine Zustimmung zur Datenschutzerklärung erforderlich:</p>
        <ul>
          <li>Deine Eingaben werden an externe KI-Dienstleister (OpenAI, USA) und Make (EU) übermittelt.</li>
          <li>Daten werden für die Antwortgenerierung verarbeitet und können außerhalb der EU gespeichert werden.</li>
          <li>Bitte gib <b>keine personenbezogenen oder sensiblen Daten</b> ein!</li>
          <li>Mehr: <a href="https://openai.com/policies/privacy-policy" target="_blank">OpenAI</a>, <a href="https://www.make.com/en/privacy-policy" target="_blank">Make.com</a>.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="modal-btn accept" id="acceptPrivacy">Zustimmen</button>
        <button class="modal-btn decline" onclick="window.location.reload()">Ablehnen</button>
      </div>
    </div>
  </div>

  <!-- 2) Wichtige Hinweise zur Bot-Nutzung -->
  <div class="modal-overlay" id="usage-modal" style="display:none;">
    <div class="modal-card">
      <div class="modal-head"><i class="fa-solid fa-bullhorn"></i>Wichtige Hinweise zur Bot-Nutzung</div>
      <div class="modal-content">
        <p>Bitte lesen Sie diese Hinweise sorgfältig durch und bestätigen Sie diese, bevor Sie den Bot verwenden.</p>
        <ul>
          <li><strong>Automatisierte Antworten:</strong><br>
            Sie interagieren mit einem automatisierten Bot-System. Alle Antworten werden von künstlicher Intelligenz generiert, nicht von einem Menschen.
          </li>
          <li><strong>Keine Gewähr für Richtigkeit:</strong><br>
            Die vom Bot bereitgestellten Informationen können unvollständig, veraltet oder fehlerhaft sein. Jede Antwort muss von Ihnen eigenständig überprüft und validiert werden.
          </li>
          <li><strong>Kein Ersatz für professionelle Beratung:</strong><br>
            Der Bot ersetzt keine professionelle Beratung, insbesondere keine:
            <ul>
              <li>Rechtsberatung</li>
              <li>Medizinische Beratung</li>
              <li>Steuerberatung</li>
              <li>Finanzberatung</li>
              <li>Andere fachspezifische Beratungsleistungen</li>
            </ul>
            Wenden Sie sich für rechtliche, medizinische oder andere fachliche Angelegenheiten immer an entsprechende Fachkräfte.
          </li>
          <li><strong>Haftungsausschluss:</strong><br>
            Jegliche Haftung für Schäden, die durch die Nutzung des Bots oder durch das Vertrauen auf die bereitgestellten Informationen entstehen, wird vollständig ausgeschlossen.
          </li>
          <li><strong>Eigenverantwortung:</strong><br>
            Sie nutzen den Bot auf eigene Verantwortung und bestätigen, dass Sie:
            <ul>
              <li>Die Grenzen des Systems verstehen</li>
              <li>Alle Antworten kritisch hinterfragen werden</li>
              <li>Bei wichtigen Entscheidungen zusätzliche Quellen konsultieren</li>
            </ul>
          </li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="modal-btn accept" id="acceptUsage">Zustimmen</button>
        <button class="modal-btn decline" onclick="window.location.reload()">Ablehnen</button>
      </div>
    </div>
  </div>

  <!-- Haupt-Interface -->
  <div id="mainContainer">
    <div class="container">
      <div class="comic">
        <img src="https://ntc-bot1.netlify.app/Bildschirmfoto%202025-06-26%20um%2021.09.25.png" alt="Dame Linda" />
        <div class="comic-name">Linda</div>
      </div>
      <div class="chat-area">
        <header>Linda. Deine persönliche Assistentin in der Proximus.</header>

        <!-- Steuerungs-Icons -->
        <div class="chat-controls">
          <button id="btnHistory" class="control-btn" title="Chatverlauf"><i class="fa-solid fa-list"></i></button>
          <button id="btnNew" class="control-btn" title="Neuer Chat"><i class="fa-solid fa-plus"></i></button>
          <button id="btnDel" class="control-btn" title="Chat löschen"><i class="fa-solid fa-trash"></i></button>
        </div>

        <!-- Chatfenster -->
        <div id="chat">
          <div class="message bot"><strong>Linda:</strong><br>Wie kann ich dir heute helfen?</div>
        </div>

        <!-- Eingabezeile -->
        <div class="input-bar">
          <button id="tools-btn" title="Tools">⚙️</button>
          <input id="q" type="text" placeholder="Deine Frage…" autocomplete="off" />
          <button id="mic-btn" title="Sprich deine Frage ein">🎤</button>
          <button id="send-btn" title="Senden">➤</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // 1) Datenschutzhinweis: beim Zustimmen weiter zum Usage-Modal
    document.getElementById('acceptPrivacy').onclick = () => {
      document.getElementById('privacy-modal').style.display = 'none';
      document.getElementById('usage-modal').style.display = 'flex';
    };

    // 2) Wichtige Hinweise: beim Zustimmen endlich das Chat-Interface zeigen
    document.getElementById('acceptUsage').onclick = () => {
      document.getElementById('usage-modal').style.display = 'none';
      document.getElementById('mainContainer').style.display = 'flex';
    };

    // Speech Recognition
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRec) {
      const recognition = new SpeechRec();
      recognition.lang = 'de-DE';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.addEventListener('start', () => document.getElementById('mic-btn').classList.add('recording'));
      recognition.addEventListener('end', () => document.getElementById('mic-btn').classList.remove('recording'));
      recognition.addEventListener('result', ev => document.getElementById('q').value = ev.results[0][0].transcript);
      document.getElementById('mic-btn').addEventListener('click', () => recognition.start());
    } else {
      document.getElementById('mic-btn').disabled = true;
    }

    // Chat-Logik mit Netlify-Webhook
    const chatEl = document.getElementById('chat');
    let messages = [{ role:'assistant', content:'Wie kann ich dir heute helfen?' }];

    function append(role, text, cls) {
      const el = document.createElement('div');
      el.className = `message ${cls}`;
      el.innerHTML = `<strong>${role==='assistant'?'Linda':'Du'}:</strong><br>` + marked.parse(text);
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function send() {
      const text = document.getElementById('q').value.trim();
      if (!text) return;
      append('user', text, 'user');
      messages.push({ role:'user', content: text });
      append('assistant', '…', 'bot');
      document.getElementById('q').value = '';
      try {
        const res = await fetch('/.netlify/functions/webhook-proxy', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages })
        });
        const raw = await res.text();
        let reply;
        try { reply = JSON.parse(raw).reply || raw; } catch { reply = raw; }
        const bots = chatEl.querySelectorAll('.message.bot');
        bots[bots.length-1].innerHTML = `<strong>Linda:</strong><br>` + marked.parse(reply);
        messages.push({ role:'assistant', content: reply });
      } catch (err) {
        const bots = chatEl.querySelectorAll('.message.bot');
        bots[bots.length-1].innerHTML = `<strong>Linda:</strong><br>Fehler: ${err.message}`;
      }
    }

    document.getElementById('send-btn').addEventListener('click', send);
    document.getElementById('q').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

    // Chat-Steuerung: Verlauf, Neu, Löschen
    document.getElementById('btnHistory').onclick = () => {
      alert(
        messages.map(m => `${m.role==='assistant'?'Linda':'Du'}: ${m.content}`)
                .join('\n\n')
      );
    };
    document.getElementById('btnNew').onclick = () => {
      if (confirm('Neuen Chat starten?')) {
        chatEl.innerHTML = '';
        messages = [];
      }
    };
    document.getElementById('btnDel').onclick = () => {
      if (confirm('Diesen Chat wirklich löschen?')) {
        chatEl.innerHTML = '';
        messages = [];
      }
    };
  </script>
</body>
</html>
