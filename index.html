<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linda ‚Äì Deine pers√∂nliche Assistentin (Comic)</title>

  <!-- Manifest & Mobile Meta -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2346e4" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="ChatBot" />

  <!-- Icons & Schriftarten -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Segoe+Script&family=Comic+Sans+MS&display=swap"
    rel="stylesheet"
  />

  <style>
    /* Reset & Global */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: 'Inter', sans-serif; }
    body { display: flex; background: #f7f7f8; color: #24292e; overflow: hidden; }

    /* Datenschutz-/Disclaimer-Modals */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,38,90,0.45);
      z-index: 3000; display: flex; align-items: center; justify-content: center;
    }
    .modal-card {
      background: #fff; border-radius: 16px; max-width: 440px; width: 95vw;
      box-shadow: 0 8px 32px rgba(0,70,160,0.13); overflow: hidden;
      border: 1.5px solid #0059b3;
    }
    .modal-head {
      background: #0059b3; color: #fff; padding: 20px 26px;
      display: flex; align-items: center; font-size: 1.12rem; font-weight: 600;
    }
    .modal-head .fa-lock, .modal-head .fa-shield-halved {
      margin-right: 12px; font-size: 1.2rem;
    }
    .modal-content { padding: 22px; font-size: 1.03rem; color: #1c273a; }
    .modal-content ul { margin: 14px 0 0 18px; }
    .modal-footer {
      display: flex; justify-content: flex-end; gap: 14px; padding: 0 22px 18px;
    }
    .modal-btn {
      padding: 11px 28px; border-radius: 20px; border: none;
      font-size: 1.06rem; font-weight: 600; cursor: pointer;
      box-shadow: 0 1px 5px rgba(0,89,179,0.06);
      transition: background .14s, color .12s;
    }
    .modal-btn.accept { background: #0059b3; color: #fff; }
    .modal-btn.accept:hover { background: #003974; }
    .modal-btn.decline {
      background: #f3f4f6; color: #0059b3; border: 1px solid #c7d5ea;
    }
    .modal-btn.decline:hover { background: #eaf1fa; color: #003974; }

    /* Haupt-Interface */
    #mainContainer { display: none; width: 100%; height: 100%; }
    .container { display: flex; width: 100%; height: 100%; }
    .comic {
      flex: 0 0 300px; background: #fff;
      display: flex; flex-direction: column; align-items: center;
      border-right: 1px solid #e1e4e8; padding: 1rem;
    }
    .comic img { width: 100%; border-radius: .5rem; }
    .comic-name {
      margin-top: .5rem; font-family: 'Segoe Script','Comic Sans MS',cursive;
      font-size: 1.5rem; color: #333;
    }
    .chat-area {
      position: relative; flex: 1; display: flex; flex-direction: column;
    }
    .chat-area header {
      padding: 1rem 1.5rem; font-size: 1.25rem; font-weight: 500;
      background: #fff; border-bottom: 1px solid #e1e4e8;
    }

    /* Steuerungs-Icons oben rechts */
    .chat-controls {
      position: absolute; top: 1rem; right: 1.5rem;
      display: flex; gap: .5rem; z-index: 5;
    }
    .control-btn {
      background: rgba(255,255,255,0.8); border: 1px solid #e1e4e8;
      border-radius: .5rem; width: 2.3rem; height: 2.3rem;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem; color: #57606a; cursor: pointer;
      transition: background .2s, color .2s;
    }
    .control-btn:hover { background: #fff; color: #24292e; }

    /* Chatfenster */
    #chat {
      flex: 1; overflow-y: auto; padding: 1rem 1.5rem;
      display: flex; flex-direction: column; gap: 1rem;
      background: #f7f7f8;
    }
    .message {
      max-width: 75%; padding: .75rem 1rem; border-radius: 1rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1.5;
    }
    .bot { align-self: flex-start; background: #fff; color: #24292e; }
    .user { align-self: flex-end; background: #0969da; color: #fff; }

    /* Input-Bar */
    .input-bar {
      display: flex; align-items: center;
      padding: .5rem 1rem calc(env(safe-area-inset-bottom)+.5rem);
      background: #fff; border-top: 1px solid #e1e4e8;
    }
    .input-bar button {
      background: none; border: none; font-size: 1.5rem;
      cursor: pointer; color: #57606a; margin: 0 .25rem;
      padding: .75rem;
    }
    .input-bar button:hover { color: #24292e; }
    #q {
      flex: 1; border: none; outline: none;
      background: #f0f4f8; border-radius: .5rem;
      padding: 1rem; margin: 0 .5rem; font-size: 1rem;
      line-height: 1.4;
    }
    .recording { color: #d00!important; }

    @media (max-width: 600px) {
      .container { flex-direction: column; }
      .comic { border-right: none; border-bottom: 1px solid #e1e4e8; }
      .chat-controls { top: .75rem; right: 1rem; }
    }
  </style>
</head>
<body>
  <!-- Datenschutz -->
  <div class="modal-overlay" id="privacy-modal">
    <div class="modal-card">
      <div class="modal-head"><i class="fa-solid fa-lock"></i>Datenschutzhinweis</div>
      <div class="modal-content">
        <p>Um diesen Chatbot nutzen zu k√∂nnen, ist deine Zustimmung zur Datenschutzerkl√§rung erforderlich:</p>
        <ul>
          <li>Deine Eingaben werden an externe KI-Dienstleister (OpenAI, USA) und die Automatisierungsplattform (Make, EU) √ºbermittelt.</li>
          <li>Die √ºbermittelten Daten werden f√ºr die Generierung von Antworten verarbeitet und k√∂nnen auf Servern au√üerhalb der EU gespeichert werden.</li>
          <li>Bitte gib <b>keine personenbezogenen oder sensiblen Daten</b> ein!</li>
          <li>Weitere Informationen: <a href="https://openai.com/policies/privacy-policy" target="_blank">OpenAI</a>, <a href="https://www.make.com/en/privacy-policy" target="_blank">Make.com</a>.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="modal-btn accept" id="acceptPrivacy">Zustimmen</button>
        <button class="modal-btn decline" onclick="window.location.reload()">Ablehnen</button>
      </div>
    </div>
  </div>

  <!-- Haftungsausschluss -->
  <div class="modal-overlay" id="disclaimer-modal" style="display:none;">
    <div class="modal-card">
      <div class="modal-head"><i class="fa-solid fa-shield-halved"></i>Haftungsausschluss</div>
      <div class="modal-content">
        <ul>
          <li>Die Antworten dieses Chatbots werden durch k√ºnstliche Intelligenz (KI) erzeugt.</li>
          <li>Es besteht <b>keine Garantie auf Richtigkeit, Vollst√§ndigkeit oder Aktualit√§t</b> der bereitgestellten Informationen.</li>
          <li>Die Nutzung des Chatbots ersetzt keine Rechts-, Steuer- oder Fachberatung.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="modal-btn accept" id="acceptDisclaimer">Einverstanden</button>
        <button class="modal-btn decline" onclick="window.location.reload()">Ablehnen</button>
      </div>
    </div>
  </div>

  <!-- Haupt-Interface -->
  <div id="mainContainer">
    <div class="container">
      <div class="comic">
        <img src="https://ntc-bot1.netlify.app/Bildschirmfoto%202025-06-26%20um%2021.09.25.png" alt="Dame Linda" />
        <div class="comic-name">Linda</div>
      </div>
      <div class="chat-area">
        <header>Linda. Deine pers√∂nliche Assistentin in der Proximus.</header>

        <!-- Steuerungs-Icons -->
        <div class="chat-controls">
          <button id="btnHistory" class="control-btn" title="Chatverlauf"><i class="fa-solid fa-list"></i></button>
          <button id="btnNew" class="control-btn" title="Neuer Chat"><i class="fa-solid fa-plus"></i></button>
          <button id="btnDel" class="control-btn" title="Chat l√∂schen"><i class="fa-solid fa-trash"></i></button>
        </div>

        <!-- Chatverlauf-Modal -->
        <div class="modal-overlay" id="history-modal" style="display:none; z-index:2000;">
          <div class="modal-card" style="max-width:600px;">
            <div class="modal-head"><i class="fa-solid fa-list"></i>Chatverlauf</div>
            <div class="modal-content" id="history-content" style="max-height:60vh; overflow:auto;"></div>
            <div class="modal-footer">
              <button class="modal-btn accept" onclick="document.getElementById('history-modal').style.display='none'">Schlie√üen</button>
            </div>
          </div>
        </div>

        <!-- Nachrichten -->
        <div id="chat">
          <div class="message bot"><strong>Linda:</strong><br>Wie kann ich dir heute helfen?</div>
        </div>

        <!-- Eingabezeile -->
        <div class="input-bar">
          <button id="tools-btn" title="Tools">‚öôÔ∏è</button>
          <input id="q" type="text" placeholder="Deine Frage‚Ä¶" autocomplete="off" />
          <button id="mic-btn" title="Sprich deine Frage ein">üé§</button>
          <button id="send-btn" title="Senden">‚û§</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Datenschutz- & Disclaimer-Logik
    document.getElementById('acceptPrivacy').onclick = () => {
      document.getElementById('privacy-modal').style.display = 'none';
      document.getElementById('disclaimer-modal').style.display = 'flex';
    };
    document.getElementById('acceptDisclaimer').onclick = () => {
      document.getElementById('disclaimer-modal').style.display = 'none';
      document.getElementById('mainContainer').style.display = 'flex';
    };

    // Sprachsteuerung
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRec) {
      const recognition = new SpeechRec();
      recognition.lang = 'de-DE';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.addEventListener('start', () => micBtn.classList.add('recording'));
      recognition.addEventListener('end', () => micBtn.classList.remove('recording'));
      recognition.addEventListener('result', ev => q.value = ev.results[0][0].transcript);
      mic-btn.addEventListener('click', () => recognition.start());
    } else {
      mic-btn.disabled = true;
    }

    // Chat-Logik mit Netlify-Webhook
    const chatEl = document.getElementById('chat');
    let messages = [{ role:'assistant', content:'Wie kann ich dir heute helfen?' }];

    function append(role, text, cls) {
      const el = document.createElement('div');
      el.className = `message ${cls}`;
      el.innerHTML = `<strong>${role==='assistant'?'Linda':'Du'}:</strong><br>`+marked.parse(text);
      chatEl.appendChild(el);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function send() {
      const text = q.value.trim();
      if (!text) return;
      append('user', text,'user');
      messages.push({ role:'user', content:text });
      append('assistant','‚Ä¶','bot');
      q.value='';
      try {
        const res = await fetch('/.netlify/functions/webhook-proxy', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ messages })
        });
        const raw = await res.text();
        let reply;
        try { reply = JSON.parse(raw).reply||raw; } catch { reply = raw; }
        const bots = chatEl.querySelectorAll('.message.bot');
        bots[bots.length-1].innerHTML = `<strong>Linda:</strong><br>`+marked.parse(reply);
        messages.push({ role:'assistant', content:reply });
      } catch(err) {
        const bots = chatEl.querySelectorAll('.message.bot');
        bots[bots.length-1].innerHTML = `<strong>Linda:</strong><br>Fehler: ${err.message}`;
      }
    }

    send-btn.addEventListener('click', send);
    q.addEventListener('keydown', e => {
      if (e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    });

    // Tools-Panel (TTS) und Chat-Steuerung
    tools-btn.addEventListener('click', () => {
      toolsPanel.style.display = toolsPanel.style.display==='block'?'none':'block';
    });
    document.addEventListener('click', e => {
      if (!toolsPanel.contains(e.target) && e.target!==tools-btn) {
        toolsPanel.style.display='none';
      }
    });

    document.getElementById('btnHistory').onclick = () => {
      const hc = document.getElementById('history-content');
      hc.innerHTML = messages.map(m =>
        `<p><strong>${m.role==='assistant'?'Linda':'Du'}:</strong> ${m.content}</p>`
      ).join('');
      document.getElementById('history-modal').style.display='flex';
    };
    document.getElementById('btnNew').onclick = () => {
      if (confirm('Einen neuen Chat starten?')) {
        chatEl.innerHTML=''; messages=[];
      }
    };
    document.getElementById('btnDel').onclick = () => {
      if (confirm('Diesen Chat wirklich l√∂schen?')) {
        chatEl.innerHTML=''; messages=[];
      }
    };

    // Initial
    document.getElementById('privacy-modal').style.display='flex';
  </script>
</body>
</html>
