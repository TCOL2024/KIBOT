<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KI-Assistent für Themen rund um Personalmanagement, Ausbildung, ...</title>
  <!-- Manifest & Mobile Meta aus zweitem HTML -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2346e4" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="ChatBot" />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <!-- Inter-Schrift wie bei Linda -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet"
  />
  <!-- Comic-Font für Namen -->
  <link
    href="https://fonts.googleapis.com/css2?family=Segoe+Script&family=Comic+Sans+MS&display=swap"
    rel="stylesheet"
  />
  <style>
    /* === Linda-Interface Styles aus erstem HTML === */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      display: flex;
      height: 100vh;
      font-family: 'Inter', sans-serif;
      background: #f7f7f8;
      color: #24292e;
      overflow: hidden;
    }
    .container {
      display: flex;
      width: 100%;
    }
    .comic {
      flex: 0 0 300px;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      border-right: 1px solid #e1e4e8;
      padding: 1rem;
    }
    .comic img {
      width: 100%;
      height: auto;
      border-radius: 0.5rem;
    }
    .comic-name {
      margin-top: 0.5rem;
      width: 100%;
      text-align: center;
      font-family: 'Segoe Script', 'Comic Sans MS', cursive;
      font-size: 1.5rem;
      color: #333;
    }
    .chat-area {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    /* Header aus Linda */
    .chat-area header {
      padding: 1rem 1.5rem;
      font-size: 1.25rem;
      font-weight: 500;
      background: #fff;
      border-bottom: 1px solid #e1e4e8;
    }
    /* Inhaltsbereich */
    #chatContainer {
      flex: 1;
      overflow-y: auto;
      padding: 1rem 1.5rem;
      background: #f7f7f8;
    }
    /* Input-Bar (wird von zweitem HTML nicht genutzt) */
    /* … hier nicht definiert, da zweites HTML eigene Input-Bar hat … */

    @media (max-width: 600px) {
      .container {
        flex-direction: column;
      }
      .comic {
        border-right: none;
        border-bottom: 1px solid #e1e4e8;
      }
    }

    /* === Modal Styles aus zweitem HTML === */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 38, 90, 0.45);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-card {
      background: #fff;
      border-radius: 16px;
      max-width: 440px;
      width: 95vw;
      box-shadow: 0 8px 32px 0 rgba(0, 70, 160, 0.13);
      padding: 0;
      overflow: hidden;
      border: 1.5px solid var(--primary, #0059b3);
      position: relative;
    }
    .modal-head {
      background: var(--primary, #0059b3);
      color: #fff;
      padding: 20px 26px;
      display: flex;
      align-items: center;
      font-size: 1.12rem;
      font-weight: 600;
    }
    .modal-head .fa-lock,
    .modal-head .fa-shield-halved {
      font-size: 1.2rem;
      margin-right: 12px;
    }
    .modal-content {
      padding: 22px 22px 10px 22px;
      color: #1c273a;
      font-size: 1.03rem;
    }
    .modal-content ul {
      margin: 14px 0 0 18px;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 14px;
      padding: 0 22px 18px 22px;
    }
    .modal-btn {
      padding: 11px 28px;
      border-radius: 20px;
      border: none;
      font-size: 1.06rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 1px 5px rgba(0, 89, 179, 0.06);
      transition: background 0.14s, color 0.12s;
    }
    .modal-btn.accept {
      background: var(--primary, #0059b3);
      color: #fff;
    }
    .modal-btn.accept:hover {
      background: var(--primary-dark, #003974);
    }
    .modal-btn.decline {
      background: #f3f4f6;
      color: var(--primary, #0059b3);
      border: 1px solid #c7d5ea;
    }
    .modal-btn.decline:hover {
      background: #eaf1fa;
      color: var(--primary-dark, #003974);
    }
  </style>
</head>
<body>
  <!-- Datenschutzhinweis -->
  <div class="modal-overlay" id="privacy-modal">
    <div class="modal-card">
      <div class="modal-head"><i class="fa-solid fa-lock"></i>Datenschutzhinweis</div>
      <div class="modal-content">
        <p>Um diesen Chatbot nutzen zu können, ist deine Zustimmung zur Datenschutzerklärung erforderlich:</p>
        <ul>
          <li>Deine Eingaben werden an externe KI-Dienstleister (OpenAI, USA) und die Automatisierungsplattform (Make, EU) übermittelt.</li>
          <li>Die übermittelten Daten werden für die Generierung von Antworten verarbeitet und können auf Servern außerhalb der EU gespeichert werden.</li>
          <li>Bitte gib <b>keine personenbezogenen oder sensiblen Daten</b> ein!</li>
          <li>Weitere Informationen: <a href="https://openai.com/policies/privacy-policy" target="_blank" rel="noopener">OpenAI</a>, <a href="https://www.make.com/en/privacy-policy" target="_blank" rel="noopener">Make.com</a>.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="modal-btn accept" id="acceptPrivacy">Zustimmen</button>
        <button class="modal-btn decline" onclick="window.location.reload()">Ablehnen</button>
      </div>
    </div>
  </div>

  <!-- Haftungsausschluss -->
  <div class="modal-overlay" id="disclaimer-modal" style="display: none;">
    <div class="modal-card">
      <div class="modal-head"><i class="fa-solid fa-shield-halved"></i>Haftungsausschluss</div>
      <div class="modal-content">
        <ul>
          <li>Die Antworten dieses Chatbots werden durch künstliche Intelligenz (KI) erzeugt.</li>
          <li>Es besteht <b>keine Garantie auf Richtigkeit, Vollständigkeit oder Aktualität</b> der bereitgestellten Informationen.</li>
          <li>Die Nutzung des Chatbots ersetzt keine Rechts-, Steuer- oder Fachberatung.</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="modal-btn accept" id="acceptDisclaimer">Einverstanden</button>
        <button class="modal-btn decline" onclick="window.location.reload()">Ablehnen</button>
      </div>
    </div>
  </div>

  <!-- Haupt-Interface (unsichtbar bis Zustimmung) -->
  <div id="mainContainer" style="display: none;">
    <div class="container">
      <!-- Comic-Seitenleiste -->
      <div class="comic">
        <img
          src="https://ntc-bot1.netlify.app/Bildschirmfoto%202025-06-26%20um%2021.09.25.png"
          alt="Dame Linda"
        />
        <div class="comic-name">Linda</div>
      </div>

      <!-- Chat-Bereich -->
      <div class="chat-area">
        <header>Linda. Deine persönliche Assistentin in der Proximus.</header>

        <!-- Hier das zweite HTML-Interface einbetten -->
        <div id="mainLayout" style="display:none; height:100%;">
          <!-- Sidebar & Chatbox aus zweitem HTML -->
          <aside class="sidebar" id="sidebar">
            <div class="sidebar-title">Chats</div>
            <div class="chat-list" id="chatList"></div>
            <button class="sidebar-btn" id="startNewChat">
              <i class="fa-solid fa-plus"></i> Neuer Chat
            </button>
          </aside>
          <div class="chatbox-outer">
            <div class="chat-header">
              <div class="bot-avatar"><i class="fa-solid fa-robot"></i></div>
              <h1>Dein KI-Assistent</h1>
              <button
                class="new-chat-btn"
                id="newChatBtn"
                title="Neuer Chat starten"
              >
                <i class="fa-solid fa-plus"></i> Neuer Chat
              </button>
              <div class="subtitle">
                Stelle deine Frage rund ums Personalmanagement
              </div>
            </div>
            <div class="messages-area" id="messages"></div>
            <form
              class="inputbar-area"
              onsubmit="event.preventDefault();sendMessage();"
            >
              <textarea
                id="userInput"
                placeholder="Nachricht eingeben..."
                rows="1"
                autocomplete="off"
              ></textarea>
              <button type="submit" class="send-btn">
                <i class="fa-solid fa-paper-plane"></i>
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Skripte: Modal-Logik + Chat-Logik aus zweitem HTML, angepasst -->
  <script>
    // Datenschutz-Modal
    document.getElementById('acceptPrivacy').onclick = function () {
      document.getElementById('privacy-modal').style.display = 'none';
      document.getElementById('disclaimer-modal').style.display = 'flex';
    };
    // Disclaimer-Modal
    document.getElementById('acceptDisclaimer').onclick = function () {
      document.getElementById('disclaimer-modal').style.display = 'none';
      document.getElementById('mainContainer').style.display = 'flex';
      // jetzt erst das Chat-Interface aktivieren
      document.getElementById('mainLayout').style.display = 'flex';
      initChatUI();
    };

    // Chat-Logik aus zweitem HTML (unverändert), inkl. Webhook-URL
    const STORAGE_KEY = 'chatgpt-jens-chats';
    let chats = [];
    let activeChatId = null;
    const introMsg = {
      sender: 'bot',
      text: 'Hallo! Ich bin dein KI-Assistent. Stelle mir deine Frage zu Personal, Ausbildung oder Prüfungsvorbereitung.',
    };

    function makeId() {
      return 'chat_' + Date.now() + '_' + Math.floor(Math.random() * 10000);
    }
    function loadChats() {
      try {
        chats = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch (e) {
        chats = [];
      }
    }
    function saveChats() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(chats));
    }
    function newChat() {
      const chat = { id: makeId(), name: 'Neuer Chat', messages: [introMsg] };
      chats.unshift(chat);
      activeChatId = chat.id;
      saveChats();
      renderChatList();
      loadChatIntoUI(chat);
    }
    function updateActiveChat(messages) {
      const idx = chats.findIndex((c) => c.id === activeChatId);
      if (idx !== -1) {
        chats[idx].messages = messages;
        const firstUser = messages.find((m) => m.sender === 'user');
        if (firstUser && chats[idx].name.startsWith('Neuer Chat'))
          chats[idx].name = firstUser.text.substring(0, 32) || chats[idx].name;
        saveChats();
        renderChatList();
      }
    }
    function renderChatList() {
      const list = document.getElementById('chatList');
      list.innerHTML = '';
      chats.forEach((chat) => {
        const div = document.createElement('div');
        div.className =
          'chat-list-item' +
          (chat.id === activeChatId ? ' active' : '');
        div.title = chat.name;
        div.innerHTML =
          '<i class="fa-solid fa-comments"></i> ' +
          (chat.name || 'Chat') +
          '<i class="fa-solid fa-trash" title="Löschen"></i>';
        div.onclick = function (e) {
          if (e.target.classList.contains('fa-trash')) {
            e.stopPropagation();
            deleteChat(chat.id);
          } else {
            activeChatId = chat.id;
            loadChatIntoUI(chat);
            renderChatList();
          }
        };
        list.appendChild(div);
      });
    }
    function deleteChat(id) {
      if (confirm('Diesen Chat wirklich löschen?')) {
        const idx = chats.findIndex((c) => c.id === id);
        if (idx !== -1) {
          chats.splice(idx, 1);
          if (activeChatId === id) {
            if (chats.length) {
              activeChatId = chats[0].id;
              loadChatIntoUI(chats[0]);
            } else {
              newChat();
            }
          }
          saveChats();
          renderChatList();
        }
      }
    }
    function loadChatIntoUI(chat) {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';
      (chat.messages || []).forEach((msg) =>
        addMessage(msg.sender, msg.text)
      );
    }
    function addMessage(sender, text) {
      const messagesDiv = document.getElementById('messages');
      const row = document.createElement('div');
      row.className = 'bubble-row ' + sender;
      const avatar = document.createElement('div');
      avatar.className = 'avatar';
      avatar.innerHTML =
        sender === 'user'
          ? '<i class="fa-solid fa-user"></i>'
          : '<i class="fa-solid fa-robot"></i>';
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + sender;
      if (sender === 'bot') {
        bubble.innerHTML = renderBotAnswer(text);
      } else {
        bubble.textContent = text;
      }
      row.appendChild(avatar);
      row.appendChild(bubble);
      messagesDiv.appendChild(row);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    function renderBotAnswer(text) {
      let html = text
        .replace(/^### (.*$)/gim, '<h3>$1</h3>')
        .replace(/^## (.*$)/gim, '<h2>$1</h2>')
        .replace(/^# (.*$)/gim, '<h1>$1</h1>')
        .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/^- (.*)$/gm, '<li>$1</li>')
        .replace(/\n{2,}/g, '</p><p>')
        .replace(/\n/g, '<br>');
      html = html.replace(/(<li>.*<\/li>)/gs, '<ul>$1</ul>');
      html = html.replace(
        /(?:Quellen?|Hinweis:)([\s\S]*)$/i,
        (_, rest) => `<div class="meta-box">${rest.trim()}</div>`
      );
      if (!html.startsWith('<p>')) html = '<p>' + html;
      if (!html.endsWith('</p>')) html = html + '</p>';
      html = html.replace(/<p><\/p>/g, '');
      return html;
    }
    async function sendMessage() {
      const userInput = document.getElementById('userInput');
      const text = userInput.value.trim();
      if (!text) return;
      addMessage('user', text);
      userInput.value = '';
      userInput.focus();
      const messagesDiv = document.getElementById('messages');
      const contextMsgs = Array.from(messagesDiv.children).map((row) => {
        const sender = row.classList.contains('user') ? 'user' : 'bot';
        const bubble = row.querySelector('.bubble');
        return {
          sender,
          text:
            sender === 'bot'
              ? bubble.innerText
              : bubble.textContent,
        };
      });
      addMessage('bot', '⏳ Einen Moment bitte ...');
      updateActiveChat([
        ...contextMsgs,
        { sender: 'bot', text: 'Einen Moment bitte ...' },
      ]);
      // Webhook-URL aus zweitem HTML
      const webhookUrl = '/.netlify/functions/webhook-proxy';
      try {
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question: text, history: contextMsgs }),
        });
        let reply = await response.text();
        messagesDiv.lastElementChild.querySelector('.bubble.bot').innerHTML = renderBotAnswer(reply);
        const allMsgs = Array.from(messagesDiv.children).map((row) => {
          const sender = row.classList.contains('user') ? 'user' : 'bot';
          const bubble = row.querySelector('.bubble');
          return {
            sender,
            text:
              sender === 'bot'
                ? bubble.innerText
                : bubble.textContent,
          };
        });
        updateActiveChat(allMsgs);
      } catch (err) {
        messagesDiv.lastElementChild.querySelector('.bubble.bot').innerHTML =
          '❌ Es ist ein Fehler aufgetreten.';
      }
    }
    function initChatUI() {
      loadChats();
      if (chats.length === 0) {
        newChat();
      } else {
        activeChatId = chats[0].id;
        loadChatIntoUI(chats[0]);
      }
      renderChatList();
      document.getElementById('newChatBtn').onclick = () => newChat();
      document.getElementById('startNewChat').onclick = () => newChat();
      const userInput = document.getElementById('userInput');
      userInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 2 + 'px';
      });
      userInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // ServiceWorker-Registrierung optional aus zweitem HTML
    window.addEventListener('DOMContentLoaded', () => {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
      }
    });
  </script>
</body>
</html>
