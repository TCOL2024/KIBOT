<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linda ‚Äì Deine pers√∂nliche Assistentin (Comic)</title>

  <!-- Manifest & Mobile Meta -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2346e4" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-title" content="ChatBot" />

  <!-- Icons & Inter-Schrift -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap"
    rel="stylesheet"
  />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; font-family: 'Inter', sans-serif; }
    body { display: flex; background: #f7f7f8; color: #24292e; overflow: hidden; }

    /* Modal-Overlay & Card */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,38,90,0.45);
      display: flex; align-items: center; justify-content: center;
      z-index: 3000;
    }
    .modal-card {
      background: #fff; border-radius: 16px;
      width: 90vw; max-width: 500px;
      box-shadow: 0 8px 32px rgba(0,70,160,0.13);
      border: 1.5px solid #0059b3;
      overflow: hidden;
    }
    .modal-head {
      background: #0059b3; color: #fff;
      padding: 20px 26px; display: flex; align-items: center;
      font-size: 1.12rem; font-weight: 600;
    }
    .modal-head .fa-lock { margin-right: 12px; font-size: 1.2rem; }
    .modal-content {
      padding: 16px 22px; font-size: 0.9rem;
      color: #1c273a; line-height: 1.4;
      max-height: 60vh; overflow-y: auto;
    }
    .modal-content ul { margin: 12px 0 0 18px; }
    .modal-content li { margin-bottom: 0.5rem; }
    .modal-footer {
      display: flex; justify-content: flex-end;
      gap: 14px; padding: 0 22px 18px;
    }
    .modal-btn {
      padding: 10px 24px; border: none;
      border-radius: 20px; font-size: 1rem;
      font-weight: 600; cursor: pointer;
      box-shadow: 0 1px 5px rgba(0,89,179,0.06);
      transition: background .14s, color .12s;
    }
    .modal-btn.accept { background: #0059b3; color: #fff; }
    .modal-btn.accept:hover { background: #003974; }
    .modal-btn.decline {
      background: #f3f4f6; color: #0059b3;
      border: 1px solid #c7d5ea;
    }
    .modal-btn.decline:hover { background: #eaf1fa; color: #003974; }

    /* Hauptinterface versteckt bis ok */
    #mainContainer { display: none; width: 100%; height: 100%; }

    .container { display: flex; width: 100%; height: 100%; }
    .comic {
      flex: 0 0 300px; background: #fff;
      display: flex; flex-direction: column; align-items: center;
      border-right: 1px solid #e1e4e8; padding: 1rem;
    }
    .comic img { width: 100%; border-radius: .5rem; }
    .comic-name {
      margin-top: .5rem;
      font-family: 'Segoe Script','Comic Sans MS',cursive;
      font-size: 1.5rem; color: #333;
    }
    .chat-area {
      position: relative; flex: 1;
      display: flex; flex-direction: column;
    }
    .chat-area header {
      padding: 1rem 1.5rem; font-size: 1.25rem; font-weight: 500;
      background: #fff; border-bottom: 1px solid #e1e4e8;
    }

    /* Controls oben rechts */
    .chat-controls {
      position: absolute; top: 1rem; right: 1.5rem;
      display: flex; gap: .5rem; z-index: 5;
    }
    .control-btn {
      background: rgba(255,255,255,0.8);
      border: 1px solid #e1e4e8; border-radius: .5rem;
      width: 2.3rem; height: 2.3rem;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem; color: #57606a; cursor: pointer;
      transition: background .2s, color .2s;
    }
    .control-btn:hover { background: #fff; color: #24292e; }

    /* Chatfenster */
    #chat {
      flex: 1; overflow-y: auto;
      padding: 1rem 1.5rem;
      display: flex; flex-direction: column; gap: 1rem;
      background: #f7f7f8;
    }
    .message {
      max-width: 75%; padding: .75rem 1rem;
      border-radius: 1rem;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      line-height: 1.5;
    }
    .bot { align-self: flex-start; background: #fff; color: #24292e; }
    .user { align-self: flex-end; background: #0969da; color: #fff; }

    /* Inputbar */
    .input-bar {
      display: flex; align-items: center;
      padding: .5rem 1rem calc(env(safe-area-inset-bottom)+.5rem);
      background: #fff; border-top: 1px solid #e1e4e8;
    }
    .input-bar button {
      background: none; border: none;
      font-size: 1.5rem; cursor: pointer;
      color: #57606a; margin: 0 .25rem; padding: .75rem;
    }
    .input-bar button:hover { color: #24292e; }
    #q {
      flex: 1; border: none; outline: none;
      background: #f0f4f8; border-radius: .5rem;
      padding: 1rem; margin: 0 .5rem;
      font-size: 1rem; line-height: 1.4;
    }
    .recording { color: #d00!important; }

    @media (max-width: 600px) {
      .container { flex-direction: column; }
      .comic { border-right: none; border-bottom: 1px solid #e1e4e8; }
      .chat-controls { top: .75rem; right: 1rem; }
    }
  </style>
</head>
<body>
  <!-- Datenschutzhinweis -->
  <div class="modal-overlay" id="privacy-modal">
    <div class="modal-card">
      <div class="modal-head"><i class="fa-solid fa-lock"></i>Datenschutzhinweis</div>
      <div class="modal-content">
        <p>Um diesen Chatbot nutzen zu k√∂nnen, ist deine Zustimmung erforderlich:</p>
        <ul>
          <li>Eingaben werden an OpenAI (USA) und Make (EU) √ºbermittelt.</li>
          <li>Daten k√∂nnen au√üerhalb der EU gespeichert werden.</li>
          <li>Keine sensiblen Daten eingeben!</li>
        </ul>
      </div>
      <div class="modal-footer">
        <button class="modal-btn accept" id="acceptPrivacy">Zustimmen</button>
        <button class="modal-btn decline" onclick="location.reload()">Ablehnen</button>
      </div>
    </div>
  </div>

  <!-- Hauptinterace -->
  <div id="mainContainer">
    <div class="container">
      <div class="comic">
        <img src="https://ntc-bot1.netlify.app/Bildschirmfoto%202025-06-26%20um%2021.09.25.png" alt="Dame Linda" />
        <div class="comic-name">Linda</div>
      </div>
      <div class="chat-area">
        <header>Linda. Deine pers√∂nliche Assistentin in der Proximus.</header>
        <div class="chat-controls">
          <button id="btnHistory" class="control-btn" title="Chatverlauf"><i class="fa-solid fa-list"></i></button>
          <button id="btnNew" class="control-btn" title="Neuer Chat"><i class="fa-solid fa-plus"></i></button>
          <button id="btnDel" class="control-btn" title="Chat l√∂schen"><i class="fa-solid fa-trash"></i></button>
        </div>
        <div id="chat"></div>
        <div class="input-bar">
          <button id="tools-btn" title="Tools">‚öôÔ∏è</button>
          <input id="q" type="text" placeholder="Deine Frage‚Ä¶" autocomplete="off" />
          <button id="mic-btn" title="Sprich deine Frage ein">üé§</button>
          <button id="send-btn" title="Senden">‚û§</button>
        </div>
      </div>
    </div>
  </div>

  <!-- History-Modal -->
  <div class="modal-overlay" id="history-modal" style="display:none; z-index:2000;">
    <div class="modal-card" style="max-width:600px;">
      <div class="modal-head"><i class="fa-solid fa-list"></i>Chatverlauf</div>
      <div class="modal-content" id="history-content"></div>
      <div class="modal-footer">
        <button class="modal-btn accept" onclick="historyModal.hide()">Schlie√üen</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // Initiale Nachricht
    const initialMsg = { role:'assistant', content:'Hallo! Wie kann ich Sie im Bereich Personalmanagement, Ausbildung oder Pr√ºfungsvorbereitung unterst√ºtzen?' };
    let messages = [ initialMsg ];

    // Helpers f√ºr Modals
    const privacyModal = document.getElementById('privacy-modal');
    const historyModal = document.getElementById('history-modal');
    function showHistoryModal(){ historyModal.style.display='flex'; }
    function hideHistoryModal(){ historyModal.style.display='none'; }

    // Anzeige-Funktionen
    const chatEl = document.getElementById('chat');
    function renderMessages(){
      chatEl.innerHTML = '';
      for(const m of messages){
        const div = document.createElement('div');
        div.className = 'message ' + (m.role==='assistant'?'bot':'user');
        div.innerHTML = `<strong>${m.role==='assistant'?'Linda':'Du'}:</strong><br>${marked.parse(m.content)}`;
        chatEl.appendChild(div);
      }
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // Modal-Logik
    document.getElementById('acceptPrivacy').onclick = () => {
      privacyModal.style.display='none';
      document.getElementById('mainContainer').style.display='flex';
      renderMessages();
    };

    // SpeechRecognition
    const SpeechRec = window.SpeechRecognition || window.webkitSpeechRecognition;
    if(SpeechRec){
      const rec = new SpeechRec();
      rec.lang='de-DE'; rec.interimResults=false; rec.maxAlternatives=1;
      rec.onstart = ()=> document.getElementById('mic-btn').classList.add('recording');
      rec.onend   = ()=> document.getElementById('mic-btn').classList.remove('recording');
      rec.onresult= e=> document.getElementById('q').value = e.results[0][0].transcript;
      document.getElementById('mic-btn').onclick = ()=> rec.start();
    } else {
      document.getElementById('mic-btn').disabled=true;
    }

    // send(): question/history-Format f√ºr Make
    async function send(){
      const inp = document.getElementById('q');
      const text = inp.value.trim();
      if(!text) return;
      messages.push({role:'user', content: text});
      renderMessages();
      inp.value='';

      messages.push({role:'assistant', content:'‚Ä¶'});
      renderMessages();

      // Sende
      const history = messages.map(m=>({role:m.role, content:m.content}));
      try{
        const res = await fetch('/.netlify/functions/webhook-proxy', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({question: text, history})
        });
        const raw = await res.text();
        const reply = JSON.parse(raw).reply||raw;
        // Ersetze das "‚Ä¶"
        messages = messages.map(m=> m.content==='‚Ä¶'&&m.role==='assistant' ? {role:'assistant',content:reply} : m);
      }catch(e){
        messages = messages.map(m=> m.content==='‚Ä¶'&&m.role==='assistant'
          ? {role:'assistant', content:'Fehler: '+e.message}
          : m);
      }
      renderMessages();
    }
    document.getElementById('send-btn').onclick = send;
    document.getElementById('q').onkeydown = e=>{
      if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); send(); }
    };

    // Chat-Verlauf anzeigen
    document.getElementById('btnHistory').onclick = ()=>{
      const hc = document.getElementById('history-content');
      hc.innerHTML = messages.map(m=>
        `<p><strong>${m.role==='assistant'?'Linda':'Du'}:</strong> ${m.content}</p>`
      ).join('');
      showHistoryModal();
    };
    document.querySelector('#history-modal .modal-footer .accept')
      .onclick = hideHistoryModal;

    // Neuer Chat
    document.getElementById('btnNew').onclick = ()=>{
      if(confirm('Neuen Chat starten?')){
        messages = [ initialMsg ];
        renderMessages();
      }
    };

    // Chat l√∂schen
    document.getElementById('btnDel').onclick = ()=>{
      if(confirm('Diesen Chat wirklich l√∂schen?')){
        messages = [];
        renderMessages();
      }
    };

    // Zeige Datenschutzmodal initial
    privacyModal.style.display='flex';
  </script>
</body>
</html>
